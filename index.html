<!DOCTYPE html>
<html lang="en">
<head>
  <!--
    Complete S3 Bucket Browser (ListObjectsV2)
    - Renders folders (CommonPrefixes) and files (Contents)
    - Items column moved to the LAST position
    - Items now shows "files: N, folders: M" for each folder (1-depth)
    - Works with S3 REST endpoint (not the static website endpoint)
    - Requires: proper Bucket Policy (public List/Get if using anonymously) and CORS

    NOTE: Replace BUCKET and REGION below with your actual values.

    License: MIT (you may copy, modify, merge, publish, distribute, sublicense, and/or sell copies with attribution)

    MIT License
    Copyright (c) 2025 https://github.com/yr-moon

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Minimal styling (Bootstrap optional) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding: 24px; }
    .hide-while-loading { display: none; }
    .pointer { cursor: pointer; }
    .breadcrumb-item + .breadcrumb-item::before { content: "/"; }
    .name-col { width: 40%; word-break: break-all; }
    .type-col { width: 120px; }
    .size-col { width: 140px; }
    .date-col { width: 220px; }
    .count-col { width: 220px; }
    .muted { opacity: 0.8; }
    .icon { display:inline-block; width: 1em; text-align:center; }
    #main-title { font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; }
    #h1-title { font-size: 1.5rem; } /* subtitle */
  </style>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/handlebars@4.7.8/dist/handlebars.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/moment.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- Main Title -->
    <div id="main-title">Input Main Title</div>

    <!-- Subtitle -->
    <h2 id="h1-title" class="mb-3"></h2>

    <!-- Breadcrumbs (for navigating prefixes) -->
    <nav aria-label="breadcrumb">
      <ol id="breadcrumbs" class="breadcrumb"></ol>
    </nav>

    <!-- Table -->
    <table class="table table-striped table-hover align-middle hide-while-loading">
      <thead class="table-light">
        <tr>
          <th class="name-col">Name</th>
          <th class="type-col">Type</th>
          <th class="count-col">Items</th>
		  <th class="size-col">Size</th>
		  <th class="date-col">Date Modified (UTC)</th>
        </tr>
      </thead>
      <tbody id="tbody-content"></tbody>
    </table>

    <!-- Row template -->
    <script id="file-or-folder" type="text/x-handlebars-template">
      <tr class="{{#if isFolder}}pointer{{/if}}" data-key="{{key}}" data-is-folder="{{isFolder}}">
        {{#if isFolder}}
          <td class="name-col">{{simpleFilename}}</td>
          <td class="type-col">Folder</td>
          <td class="count-col" data-count="pending">…</td>
		  <td class="size-col muted">—</td>
		  <td class="date-col muted">—</td>
        {{else}}
          <td class="name-col"><a href="{{url}}" target="_blank" rel="noopener noreferrer">{{simpleFilename}}</a></td>
          <td class="type-col">{{type}}</td>
          <td class="count-col muted">—</td>
		  <td class="size-col">{{friendlySizeName}}</td>
		  <td class="date-col">{{friendlyLastModified}}</td>
        {{/if}}
      </tr>
    </script>

    <!-- Status / Error panel -->
    <div id="status" class="mt-3 text-muted"></div>
  </div>

  <script>
  (function($){
    "use strict";

    var BUCKET  = '<your-bucket-name>';
    var REGION  = '<your-region>';
    var PREFIX  = '';
    var DELIM   = '/';

    function sizeToFriendly(size){
      var n = parseInt(size, 10) || 0;
      if (n === 0) return '';
      var KB = 1024, MB = 1000*1000, GB = 1000*1000*1000;
      if (n < KB) return n + ' B';
      if (n < MB) return (n/KB).toFixed(0) + ' KB';
      if (n < GB) return (n/MB).toFixed(2) + ' MB';
      return (n/GB).toFixed(2) + ' GB';
    }

    function buildListUrl(bucket, region, prefix, delimiter){
      var base = 'https://' + bucket + '.s3.' + region + '.amazonaws.com/';
      var params = ['list-type=2', 'delimiter=' + encodeURIComponent(delimiter)];
      if (prefix) params.push('prefix=' + encodeURIComponent(prefix));
      return base + '?' + params.join('&');
    }

    function buildListUrlWithToken(bucket, region, prefix, delimiter, token){
      var url = buildListUrl(bucket, region, prefix, delimiter);
      if (token) url += '&continuation-token=' + encodeURIComponent(token);
      return url;
    }

    function buildRecursiveListUrlWithToken(bucket, region, prefix, token){
      var url = buildListUrl(bucket, region, prefix, null);
      if (token) url += '&continuation-token=' + encodeURIComponent(token);
      return url;
    }

    function firstTextByLocalName($root, localName){
      var $el = $root.find('*').filter(function(){ return this.localName === localName; }).first();
      return $el.text();
    }

    function renderBreadcrumbs(prefix){
      var $bc = $('#breadcrumbs');
      $bc.empty();
      var parts = prefix ? prefix.split(DELIM).filter(Boolean) : [];
      var $root = $('<li/>', { class: 'breadcrumb-item' }).append(
        $('<a/>', { href: '#', text: BUCKET, click: function(e){ e.preventDefault(); navigateTo(''); } })
      );
      $bc.append($root);
      var acc = '';
      for (var i = 0; i < parts.length; i++){
        acc += parts[i] + DELIM;
        var isLast = (i === parts.length - 1);
        var $li = $('<li/>', { class: 'breadcrumb-item' + (isLast ? ' active' : ''), 'aria-current': isLast ? 'page' : null });
		(function(p, label){
            $li.append($('<a/>', { href: '#', text: label, click: function(e){ e.preventDefault(); navigateTo(p); } }));
          })(acc, parts[i]);
        $bc.append($li);
      }
    }

    function FileOrFolder(opts){
      this.isFolder = !!opts.isFolder;
      this.key = opts.key || '';
      this.size = opts.size || '0';
      this.lastModified = opts.lastModified || '';
      this.url = opts.url || '#';
      var rel = PREFIX ? this.key.replace(PREFIX, '') : this.key;
      if (this.isFolder && rel.endsWith(DELIM)) rel = rel.slice(0, -1);
      var levels = rel.split(DELIM).filter(Boolean);
      this.numLevels = levels.length;
      this.simpleFilename = levels[levels.length - 1] || rel || '/';
      this.friendlySizeName = sizeToFriendly(this.size);
      var ext = (!this.isFolder && this.simpleFilename.indexOf('.') > -1) ? this.simpleFilename.split('.').pop() : '';
      this.type = this.isFolder ? 'Folder' : (ext ? (ext.toUpperCase() + ' file') : 'Unknown');
      this.friendlyLastModified = this.lastModified ? this.friendlyLastModified = moment.utc(this.lastModified).format('MMM Do YYYY, HH:mm:ss') : '';
    }

    var compiledTemplate = Handlebars.compile($('#file-or-folder').html());
    function renderRows(rows){
      var $tbody = $('#tbody-content');
      var html = '';
      for (var i = 0; i < rows.length; i++) html += compiledTemplate(rows[i]);
      $tbody.empty().append(html);

      $tbody.find('tr').each(function(){
        var $tr = $(this);
        var isFolder = $tr.data('is-folder') === true || $tr.data('is-folder') === 'true';
        var key = $tr.data('key');
        if (isFolder){
					$tr.on('click', function(){ navigateTo(key); });
					updateFolderMeta($tr, key);
					}
      });

      fetchCountsForVisibleFolders();
    }
		
    function updateFolderMeta($tr, prefix){
      var $dateCell = $tr.find('.date-col');
      var $countCell = $tr.find('.count-col');
      $dateCell.text('…');
      $countCell.text('…');

      var files = 0, folders = 0;
      function pageCounts(token){
        var url = buildListUrlWithToken(BUCKET, REGION, prefix, DELIM, token);
        $.ajax({
          url: url,
          method: 'GET',
          dataType: 'xml',
          success: function(xml){
            var $xml = $(xml);
            $xml.find('*').filter(function(){ return this.localName === 'Contents'; }).each(function(){
              var key = firstTextByLocalName($(this), 'Key');
              if (key && !key.endsWith(DELIM)){
                var rel = key.substring(prefix.length);
                if (rel && rel.indexOf(DELIM) === -1) files += 1;
              }
            });
            $xml.find('*').filter(function(){ return this.localName === 'CommonPrefixes'; }).each(function(){ folders += 1; });
            var isTruncated = firstTextByLocalName($xml, 'IsTruncated');
            if (isTruncated && isTruncated.toLowerCase() === 'true'){
              var next = firstTextByLocalName($xml, 'NextContinuationToken');
              pageCounts(next);
            } else {
              $countCell.text('files: ' + files + ', folders: ' + folders);
            }
          },
          error: function(){ $countCell.text('?'); }
        });
      }

      var newest = null;
      function pageNewest(token){
        var url = buildRecursiveListUrlWithToken(BUCKET, REGION, prefix, token);
        $.ajax({
          url: url,
          method: 'GET',
          dataType: 'xml',
          success: function(xml){
            var $xml = $(xml);
            $xml.find('*').filter(function(){ return this.localName === 'Contents'; }).each(function(){
              var key = firstTextByLocalName($(this), 'Key');
              var lm  = firstTextByLocalName($(this), 'LastModified');
              if (key && !key.endsWith(DELIM)){
                if (lm && (!newest || new Date(lm) > new Date(newest))) newest = lm;
              }
            });
            var isTruncated = firstTextByLocalName($xml, 'IsTruncated');
            if (isTruncated && isTruncated.toLowerCase() === 'true'){
              var next = firstTextByLocalName($xml, 'NextContinuationToken');
              pageNewest(next);
            } else {
              $dateCell.text(newest ? moment.utc(newest).format('MMM Do YYYY, HH:mm:ss') : '—');
            }
          },
          error: function(){ $dateCell.text('?'); }
        });
      }

      pageCounts(null);
      pageNewest(null);
    }


    function navigateTo(prefix){
      PREFIX = prefix || '';
      fetchAndRender();
    }

    function countItemsInPrefix(prefix, onDone){
      var files = 0;
      var folders = 0;
      function page(nextToken){
        var url = buildListUrlWithToken(BUCKET, REGION, prefix, DELIM, nextToken);
        $.ajax({
          url: url,
          method: 'GET',
          dataType: 'xml',
          success: function(xml){
            var $xml = $(xml);
            $xml.find('*').filter(function(){ return this.localName === 'Contents'; }).each(function(){
              var key = firstTextByLocalName($(this), 'Key');
              if (key && !key.endsWith(DELIM) && key.indexOf(prefix) === 0) {
                var rel = key.substring(prefix.length);
                if (rel && rel.indexOf(DELIM) === -1) files += 1;
              }
            });
            $xml.find('*').filter(function(){ return this.localName === 'CommonPrefixes'; }).each(function(){
              var p = firstTextByLocalName($(this), 'Prefix');
              if (p && p.indexOf(prefix) === 0) {
                folders += 1;
              }
            });
            var isTruncated = firstTextByLocalName($xml, 'IsTruncated');
            if (isTruncated && isTruncated.toLowerCase() === 'true'){
              var token = firstTextByLocalName($xml, 'NextContinuationToken');
              page(token);
            } else {
              onDone({files: files, folders: folders});
            }
          },
          error: function(){ onDone(null); }
        });
      }
      page(null);
    }

    function fetchCountsForVisibleFolders(){
      $('#tbody-content tr').each(function(){
        var $tr = $(this);
        var isFolder = $tr.data('is-folder') === true || $tr.data('is-folder') === 'true';
        if (!isFolder) return;
        var prefix = $tr.data('key');
        var $cell = $tr.find('.count-col');
        $cell.text('…');
        countItemsInPrefix(prefix, function(result){
          if (!result) {
            $cell.text('?');
          } else {
            $cell.text('files: ' + result.files + ', folders: ' + result.folders);
          }
        });
      });
    }

    function fetchAndRender(){
      $('#status').text('');
      $('.hide-while-loading').hide();
      var listUrl = buildListUrl(BUCKET, REGION, PREFIX, DELIM);
      renderBreadcrumbs(PREFIX);
      $.ajax({
        url: listUrl,
        method: 'GET',
        dataType: 'xml',
        success: function(xml){
          var $xml = $(xml);
          var xmlBucketName = firstTextByLocalName($xml, 'Name') || BUCKET;
          var title = 'S3 Bucket Browser';
          $('#h1-title').text(title);
          document.title = title;
          var rows = [];
          $xml.find('*').filter(function(){ return this.localName === 'CommonPrefixes'; }).each(function(){
            var prefix = firstTextByLocalName($(this), 'Prefix');
            if (prefix){
              rows.push(new FileOrFolder({ isFolder: true, key: prefix }));
            }
          });
          $xml.find('*').filter(function(){ return this.localName === 'Contents'; }).each(function(){
            var key  = firstTextByLocalName($(this), 'Key');
            var size = firstTextByLocalName($(this), 'Size') || '0';
            var lm   = firstTextByLocalName($(this), 'LastModified') || '';
            if (!key || key.endsWith(DELIM) || (PREFIX && key === PREFIX)) return;
            var fileUrl = 'https://' + BUCKET + '.s3.' + REGION + '.amazonaws.com/' + encodeURI(key);
            rows.push(new FileOrFolder({ isFolder: false, key: key, size: size, lastModified: lm, url: fileUrl }));
          });
          rows.sort(function(a, b){
            if (a.isFolder !== b.isFolder) return a.isFolder ? -1 : 1;
            if (a.numLevels !== b.numLevels) return a.numLevels - b.numLevels;
            return a.key.localeCompare(b.key);
          });
          renderRows(rows);
          $('.hide-while-loading').show();
          if (rows.length === 0){
            $('#status').html('No objects under <code>' + (PREFIX || '/') + '</code>.');
          }
        },
        error: function(xhr){
          $('#h1-title').text('Failed to load bucket index');
          var msg = 'Failed to list bucket. Check CORS, bucket policy, region & endpoint.';
          if (xhr && xhr.status) msg += ' HTTP ' + xhr.status;
          $('#status').text(msg);
          $('.hide-while-loading').show();
        }
      });
    }

    $(function(){ fetchAndRender(); });

  })(jQuery);
  </script>
</body>
</html>
